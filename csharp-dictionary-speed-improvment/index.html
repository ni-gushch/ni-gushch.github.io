
<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://baldman.justsquad.su/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://baldman.justsquad.su/abridge.css?h=60f85cd1fde7d35ccdfb" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://baldman.justsquad.su" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://baldman.justsquad.su/manifest.min.json" />
  <link rel="mask-icon" href="https://baldman.justsquad.su/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="icon" type="image/svg+xml" href="https://baldman.justsquad.su/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://baldman.justsquad.su/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://baldman.justsquad.su/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://baldman.justsquad.su/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="BaldMan Atom Feed" href="https://baldman.justsquad.su/atom.xml" />
  <meta name="analytics" content="my-analytics-id" /><meta name="advertising" content="my-advertising-id" /> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8T5L2SDRTX"></script> <script>  window.dataLayer = window.dataLayer || [];  function gtag(){dataLayer.push(arguments);}  gtag('js\', new Date());  gtag('config', 'G-8T5L2SDRTX'); </script> <meta name="yandex-verification" content="b387010222fc81c7" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>Ускоряем работу C# Dictionary в 2 раза. | BaldMan</title>
  <meta name="author" content="Nikolay Gushcharin" />
  <meta name="copyright" content="BaldMan" />
  <meta name="description" content="Способ оптимизации работы типа Dictionary в языке программирования C#." />
  <link rel="canonical" href="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/" />
  <meta name="keywords" content="DotNET, C#, Dictionary, .NET, C#, Rust, k8s, k3s, Gushcharin, Гущарин, Николай Гущарин, Nikolay Gushcharin, BaldMan" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/" />
  <meta name="twitter:url" content="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/" />
  <meta property="og:description" content="Способ оптимизации работы типа Dictionary в языке программирования C#." />
  <meta name="twitter:description" content="Способ оптимизации работы типа Dictionary в языке программирования C#." />
  <meta property="og:title" content="Ускоряем работу C# Dictionary в 2 раза. | BaldMan" />
  <meta name="twitter:title" content="Ускоряем работу C# Dictionary в 2 раза. | BaldMan" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://baldman.justsquad.su/banner.png" />
  <meta property="og:image" content="https://baldman.justsquad.su/banner.png" />
  <meta property="og:site_name" content="BaldMan" />
  <meta property="og:locale" content="ru_RU" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2025-04-18" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://baldman.justsquad.su/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <script defer src="https://baldman.justsquad.su/js/lunr.stemmer.support.min.js" integrity="sha384-f0MKdC/9ZSGTpDiuWusC0SbLXNCBp6NgzDZpjR/4UdHXAQBqvTEKyinnsa1wQ7oA"></script>
  <script defer src="https://baldman.justsquad.su/js/lunr.ru.min.js" integrity="sha384-R9oqgx8XLmQUPG/odEJyFPd90/TbRU0/6q+If/f8d5yDqLhZgtOT5/X9r3O1Etjr"></script>
  <noscript><link rel="stylesheet" href="https://baldman.justsquad.su/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://baldman.justsquad.su" title="BaldMan"><img src="https://baldman.justsquad.su/logo.svg" alt="BaldManLogo" width="128" height="128" />BaldMan</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://baldman.justsquad.su/archive/"> Архив </a></li><li><a class="s110" href="https://baldman.justsquad.su/tags/"> Теги </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Поиск" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
    <hr />
  </header>
  <main>
    <article>
      <h1><a href="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/">Ускоряем работу C# Dictionary в 2 раза.</a></h1>

      <span class="s95"> Nikolay Gushcharin <span class="rpad"></span> апреля 18, 2025 <span class="rpad"></span>Изменено: апреля 18, 2025 <span class="rpad"></span> #<a href="https://baldman.justsquad.su/tags/dotnet/">dotnet</a>  #<a href="https://baldman.justsquad.su/tags/csharp/">csharp</a>  #<a href="https://baldman.justsquad.su/tags/dictionary/">dictionary</a>  #<a href="https://baldman.justsquad.su/tags/cs/">cs</a> </span>

    
        <div class="block">
      <div class="blockdiv">
        <a class="b s150" href="https://baldman.justsquad.su/tags/dotnet/">dotnet (Series)</a><br>
            <a class="scur" href="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/">Ускоряем работу C# Dictionary в 2 раза.</a><br> 
          
      </div>
    </div>


<p>Давайте поговорим о том, как оптимизировать производительность типа <code>Dictionary</code> в C#.</p>
<p>Этот тип данных — один из самых популярных типов коллекций .NET, и его правильное использование может значительно улучшить производительность вашего приложения. Сначала рассмотрим немного теории работы словаря, а после познакомимся со способами ускорения методов вставки элементов.</p>
<h2 id="kak-rabotaet-dictionary">Как работает Dictionary?</h2>
<p>Перед тем как перейти к оптимизации, давайте разберемся, как вообще работает <code>Dictionary</code>.</p>
<p>Словарь представляет собой реализацию стандартной хеш-таблицы. Его суть работы состоит в том, чтобы однозначно связать ключ с его значением. И каждый раз когда мы делаем запрос по этому ключу, мы всегда должны получать одно и то же значение. Ключи могут быть как ссылочными, так и значимыми типами. Инициализация происходит либо при создании (если передана начальный размер коллекции), либо при добавлении первого элемента, причем в качестве размера будет выбрано ближайшее простое число. При этом создаются 2 внутренние коллекции — <strong>int[] buckets</strong> и <strong>Entry[] entries</strong>.</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-meta z-class z-cs"><span class="z-storage z-type z-class z-cs">class</span> <span class="z-entity z-name z-class z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-punctuation z-separator z-type z-cs">:</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IDictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">ICollection</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">KeyValuePair</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IEnumerable</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">KeyValuePair</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IEnumerable</span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IDictionary</span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">ICollection</span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IReadOnlyDictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IReadOnlyCollection</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">KeyValuePair</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">ISerializable</span><span class="z-punctuation z-separator z-inherited-class z-cs">,</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-entity z-other z-inherited-class z-cs">IDeserializationCallback</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">    <span class="z-storage z-modifier z-cs">where</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-punctuation z-separator z-type z-cs">:</span> <span class="z-entity z-other z-inherited-class z-cs">notnull</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs">  </span><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-preprocessor z-cs">    <span class="z-keyword z-other z-preprocessor z-cs"><span class="z-punctuation z-definition z-preprocessor z-cs">#</span></span><span class="z-invalid z-illegal z-cs">nullable disable</span></span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">int</span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-begin z-cs">[</span><span class="z-punctuation z-section z-brackets z-end z-cs">]</span></span> <span class="z-variable z-other z-member z-cs">_buckets</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-property z-cs"><span class="z-variable z-other z-member z-cs">Entry</span></span>[] <span class="z-variable z-other z-member z-cs">_entries</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">ulong</span> <span class="z-variable z-other z-member z-cs">_fastModMultiplier</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">int</span> <span class="z-variable z-other z-member z-cs">_count</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">int</span> <span class="z-variable z-other z-member z-cs">_freeList</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">int</span> <span class="z-variable z-other z-member z-cs">_freeCount</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-storage z-type z-cs">int</span> <span class="z-variable z-other z-member z-cs">_version</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-support z-type z-cs">IEqualityComparer</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-other z-member z-cs">_comparer</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-property z-cs"><span class="z-variable z-other z-member z-cs">KeyCollection</span></span> <span class="z-variable z-other z-member z-cs">_keys</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-property z-cs"><span class="z-variable z-other z-member z-cs">ValueCollection</span></span> <span class="z-variable z-other z-member z-cs">_values</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span></code></pre>
<p>Первая будет содержать индексы элементов во второй коллекции, а она, в свою очередь, сами элементы в таком виде:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs">    <span class="z-storage z-modifier z-access z-cs">private</span> <span class="z-meta z-struct z-cs"><span class="z-storage z-type z-struct z-cs">struct</span> <span class="z-entity z-name z-struct z-cs">Entry</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-struct z-cs">   </span><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs">     <span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-type z-cs">uint</span> <span class="z-variable z-other z-member z-cs">hashCode</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs">     <span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-type z-cs">int</span> <span class="z-variable z-other z-member z-cs">next</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs">     <span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-other z-member z-cs">key</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs">     <span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-variable z-other z-member z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-struct z-body z-cs"><span class="z-meta z-block z-cs">   <span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></code></pre>
<p>При добавлении элемента вычисляется хэшкод его ключа и затем — индекс корзины в которую он будет добавлен по модулю от величины коллекции. Затем проверяется нет ли уже такого ключа в коллекции, если есть — то операция Add выбросит исключение, а присваивание по индексу просто заменит элемент на новый.</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> выбросит исключение
</span></span><span class="z-source z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">Add</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-constant z-numeric z-integer z-decimal z-cs">10</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-constant z-numeric z-integer z-decimal z-cs">20</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span><span class="z-source z-cs">
</span><span class="z-source z-cs"><span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> просто подменит значение на новое
</span></span><span class="z-source z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-begin z-cs">[</span></span><span class="z-meta z-brackets z-cs"><span class="z-constant z-numeric z-integer z-decimal z-cs">10</span></span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-end z-cs">]</span></span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-constant z-numeric z-integer z-decimal z-cs">20</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></code></pre>
<p>Если достигнут максимальный размер словаря, то происходит расширение (выбирается новый размер в 2 раза больше предыдущего, и округляется до ближайшего простого числа). Дальше старый словарь полностью копируется в новое выделенное место. А старая область памяти будет подвержена сборки мусора. Сложность такой операции будет соответственно — O(n).</p>
<p>Если происходит коллизия (в корзине индексов <code>_buckets</code> уже есть элемент), то новый элемент добавляется в коллекцию, его индекс сохраняется в корзине, а индекс старого элемента — в его поле next.</p>
<p><img src="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/./images/image_1.png" alt="Пример работы с колизией" /></p>
<p>В результате мы получаем односвязный список относительно дублируемого ключа хеширования. Данный механизм разрешения коллизий называется <strong>chaining</strong>. Чтобы предотвратить такое поведение, необходимо выбирать такой алгоритм в методе <code>GetHashCode</code>, который будет давать максимально уникальные значения.</p>
<h2 id="problema-dvoinogo-kheshirovaniia">Проблема двойного хеширования</h2>
<p>Предположим, необходимо выполнить вставку в словарь какого-либо значения, но перед этим проверить, если ключ уже существует, то вернуть то значение которое уже было записано:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-keyword z-operator z-cs">!</span><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">ContainsKey</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span>
</span><span class="z-source z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span></span><span class="z-meta z-block z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">dictionary</span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-begin z-cs">[</span></span><span class="z-meta z-brackets z-cs"><span class="z-variable z-other z-cs">key</span></span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-end z-cs">]</span></span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-block z-cs"></span><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span>
</span></code></pre>
<p>На первый взгляд, это кажется логичным решением. Но проблема заключается в том, что здесь происходит <strong>двойное хеширование</strong>:</p>
<ol>
<li>При вызове <code>ContainsKey</code> вычисляется хеш для проверки существования ключа.</li>
<li>При добавлении элемента снова вычисляется хеш.</li>
</ol>
<p>Это приводит к дополнительной нагрузке, особенно если такая операция выполняется в цикле или в горячих путях программы.</p>
<h2 id="reshenie-problemy-cherez-trygetvalue">Решение проблемы через TryGetValue</h2>
<p>Одним из способов минимизировать эту проблему является использование метода <code>TryGetValue</code>:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-keyword z-operator z-cs">!</span><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">TryGetValue</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-storage z-modifier z-argument z-cs">out</span> <span class="z-variable z-other z-cs">_</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span>
</span><span class="z-source z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span></span><span class="z-meta z-block z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">dictionary</span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-begin z-cs">[</span></span><span class="z-meta z-brackets z-cs"><span class="z-variable z-other z-cs">key</span></span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-end z-cs">]</span></span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-block z-cs"></span><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span>
</span></code></pre>
<p>Этот подход позволяет избежать явного вызова <code>ContainsKey</code>, но все равно требует двух обращений к словарю:</p>
<ol>
<li>Проверка наличия ключа.</li>
<li>Добавление значения.</li>
</ol>
<p>Например, у класса ConcurrentDictionary есть метод GetOrAdd, который лишен проблемы с двойным доступом к словарю.</p>
<p>Как можно упростить работу и сохранить функционал? Для начала можно обернуть двойной доступ в отдельный метод GetOrAdd и там разместить методы по добавлению значения.</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs">
</span><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-meta z-class z-cs"><span class="z-storage z-type z-class z-cs">class</span> <span class="z-entity z-name z-class z-cs">DictionaryExtensions</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-class z-cs"></span><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-meta z-method z-cs"><span class="z-entity z-name z-function z-cs">GetOrAdd</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span></span><span class="z-meta z-method z-cs"><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-begin z-cs">(</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-storage z-modifier z-parameter z-cs">this</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-parameter z-cs">dictionary</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-parameter z-cs">key</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-variable z-parameter z-cs">value</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-end z-cs">)</span></span><span class="z-meta z-method z-cs">
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-cs">        <span class="z-storage z-modifier z-cs">where</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-punctuation z-separator z-type z-cs">:</span> <span class="z-entity z-other z-inherited-class z-cs">notnull</span>
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-cs">    </span><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">        <span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-keyword z-operator z-cs">!</span><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">TryGetValue</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-storage z-modifier z-argument z-cs">out</span> <span class="z-variable z-other z-cs">existedValue</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span>
</span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">        <span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span></span><span class="z-meta z-block z-cs">
</span></span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-block z-cs">            <span class="z-variable z-other z-cs">dictionary</span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-begin z-cs">[</span></span><span class="z-meta z-brackets z-cs"><span class="z-variable z-other z-cs">key</span></span><span class="z-meta z-brackets z-cs"><span class="z-punctuation z-section z-brackets z-end z-cs">]</span></span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-block z-cs">            <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-block z-cs">        </span><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span>       
</span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">        <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-variable z-other z-cs">existedValue</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-class z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span><span class="z-source z-cs">
</span></code></pre>
<p>Но это не решает проблему. Мы все равно делаем две операции доступа по ключу.</p>
<p>Можно ли сделать лучше?</p>
<h2 id="effektivnoe-reshenie-cherez-collectionmarshal">Эффективное решение через CollectionMarshal</h2>
<p>Да, можно! В современном .NET есть класс <code>System.Runtime.InteropServices.CollectionsMarshal</code>, который предоставляет метод <code>TryGetValueRefOrAddDefault</code>. Он позволяет получить ссылку на значение по ключу или добавить значение за одно обращение к словарю. Вот пример использования:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-keyword z-control z-import z-cs">using</span> <span class="z-meta z-path z-cs">System</span><span class="z-punctuation z-separator z-namespace z-cs">.</span><span class="z-meta z-path z-cs">Runtime</span><span class="z-punctuation z-separator z-namespace z-cs">.</span><span class="z-meta z-path z-cs">InteropServices</span><span class="z-punctuation z-terminator z-cs">;</span>
</span><span class="z-source z-cs">
</span><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-meta z-method z-cs"><span class="z-entity z-name z-function z-cs">GetOrAdd</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span></span><span class="z-meta z-method z-cs"><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-begin z-cs">(</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-storage z-modifier z-parameter z-cs">this</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-parameter z-cs">dictionary</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-parameter z-cs">key</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-variable z-parameter z-cs">defaultValue</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-end z-cs">)</span></span><span class="z-meta z-method z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs"></span><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">ArgumentNullException</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">ThrowIfNull</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-cs">ref</span> <span class="z-support z-type z-cs">var</span> <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-variable z-cs">=</span> <span class="z-keyword z-other z-cs">ref</span> <span class="z-variable z-other z-cs">CollectionsMarshal</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">GetValueRefOrAddDefault</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-storage z-modifier z-argument z-cs">out</span> <span class="z-storage z-type z-cs">bool</span> <span class="z-variable z-other z-cs">exists</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">exists</span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span> <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-variable z-other z-cs">slot</span><span class="z-keyword z-operator z-cs">!</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></code></pre>
<p>Этот метод доступен начиная с .NET 6 и выше. Он особенно полезен, когда вам нужно выполнять операции "получить или добавить" в высокопроизводительных частях кода.</p>
<h2 id="rasshirenie-funktsional-nosti">Расширение функциональности</h2>
<p>Кроме <code>GetOrAdd</code>, вы можете реализовать другие полезные методы для словарей, например:</p>
<h3 id="tryupdate">TryUpdate</h3>
<p>Метод <code>TryUpdate</code> позволяет обновить значение по ключу, если ключ уже существует:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-storage z-type z-cs">bool</span> <span class="z-meta z-method z-cs"><span class="z-entity z-name z-function z-cs">TryUpdate</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span></span><span class="z-meta z-method z-cs"><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-begin z-cs">(</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-storage z-modifier z-parameter z-cs">this</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-parameter z-cs">dictionary</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-parameter z-cs">key</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-variable z-parameter z-cs">value</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-end z-cs">)</span></span><span class="z-meta z-method z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs">    <span class="z-storage z-modifier z-cs">where</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-punctuation z-separator z-type z-cs">:</span> <span class="z-entity z-other z-inherited-class z-cs">notnull</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs"></span><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">ArgumentNullException</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">ThrowIfNull</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-cs">ref</span> <span class="z-support z-type z-cs">var</span> <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-variable z-cs">=</span> <span class="z-keyword z-other z-cs">ref</span> <span class="z-variable z-other z-cs">CollectionsMarshal</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">GetValueRefOrNullRef</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">Unsafe</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">IsNullRef</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-storage z-modifier z-argument z-cs">ref</span> <span class="z-variable z-other z-cs">slot</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span> <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-constant z-language z-cs">false</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-constant z-language z-cs">true</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></code></pre>
<p>Таким же образом можно создать другие методы расширения для словарей, например:</p>
<h3 id="removeifexists">RemoveIfExists</h3>
<p>Позволяет удалить ключ, если он существует.</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-storage z-type z-cs">bool</span> <span class="z-meta z-method z-cs"><span class="z-entity z-name z-function z-cs">RemoveIfExists</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span></span><span class="z-meta z-method z-cs"><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-begin z-cs">(</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-storage z-modifier z-parameter z-cs">this</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-parameter z-cs">dictionary</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-parameter z-cs">key</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-end z-cs">)</span></span><span class="z-meta z-method z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs">    <span class="z-storage z-modifier z-cs">where</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-punctuation z-separator z-type z-cs">:</span> <span class="z-entity z-other z-inherited-class z-cs">notnull</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs"></span><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">ArgumentNullException</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">ThrowIfNull</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Получаем ссылку на значение по ключу или null, если ключа нет
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-cs">ref</span> <span class="z-support z-type z-cs">var</span> <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-variable z-cs">=</span> <span class="z-keyword z-other z-cs">ref</span> <span class="z-variable z-other z-cs">CollectionsMarshal</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">GetValueRefOrNullRef</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Если ссылка не является null, значит ключ существует
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-conditional z-if z-cs">if</span> <span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">Unsafe</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">IsNullRef</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-storage z-modifier z-argument z-cs">ref</span> <span class="z-variable z-other z-cs">slot</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span> <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-constant z-language z-cs">false</span><span class="z-punctuation z-terminator z-statement z-cs">;</span> <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Ключ не существует, ничего не делаем
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">Remove</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span> <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Удаляем ключ
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-keyword z-control z-flow z-return z-cs">return</span> <span class="z-constant z-language z-cs">true</span><span class="z-punctuation z-terminator z-statement z-cs">;</span> <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Возвращаем true, так как ключ был удален
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></code></pre>
<h3 id="upsert">Upsert</h3>
<p>Позволяет обновить значение, если ключ существует, или добавить новое значение.</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-storage z-modifier z-access z-cs">public</span> <span class="z-storage z-modifier z-cs">static</span> <span class="z-storage z-type z-cs">void</span> <span class="z-meta z-method z-cs"><span class="z-entity z-name z-function z-cs">Upsert</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span></span><span class="z-meta z-method z-cs"><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-begin z-cs">(</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-storage z-modifier z-parameter z-cs">this</span> <span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-support z-type z-cs">TKey</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-support z-type z-cs">TValue</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span> <span class="z-variable z-parameter z-cs">dictionary</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-variable z-parameter z-cs">key</span><span class="z-punctuation z-separator z-parameter z-function z-cs">,</span> <span class="z-support z-type z-cs">TValue</span> <span class="z-variable z-parameter z-cs">value</span></span><span class="z-meta z-method z-parameters z-cs"><span class="z-punctuation z-section z-parameters z-end z-cs">)</span></span><span class="z-meta z-method z-cs">
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs">    <span class="z-storage z-modifier z-cs">where</span> <span class="z-support z-type z-cs">TKey</span> <span class="z-punctuation z-separator z-type z-cs">:</span> <span class="z-entity z-other z-inherited-class z-cs">notnull</span>
</span></span><span class="z-source z-cs"><span class="z-meta z-method z-cs"></span><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-begin z-cs">{</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">ArgumentNullException</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">ThrowIfNull</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Получаем ссылку на значение по ключу или default(TValue), если ключа нет
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-storage z-modifier z-cs">ref</span> <span class="z-support z-type z-cs">var</span> <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-variable z-cs">=</span> <span class="z-keyword z-other z-cs">ref</span> <span class="z-variable z-other z-cs">CollectionsMarshal</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">GetValueRefOrAddDefault</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-variable z-other z-cs">key</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-storage z-modifier z-argument z-cs">out</span> <span class="z-variable z-other z-cs">_</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Если ключ существует, обновляем значение
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> Если же не существует, то добавляем значение
</span></span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs">    <span class="z-variable z-other z-cs">slot</span> <span class="z-keyword z-operator z-assignment z-cs">=</span> <span class="z-variable z-language z-cs">value</span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span></span></span><span class="z-source z-cs"><span class="z-meta z-method z-body z-cs"><span class="z-meta z-block z-cs"><span class="z-punctuation z-section z-block z-end z-cs">}</span></span></span>
</span></code></pre>
<h2 id="prakticheskii-primer">Практический пример</h2>
<p>Давайте рассмотрим практический пример использования этих методов:</p>
<pre data-lang="cs" class="language-cs z-code"><code class="language-cs" data-lang="cs"><span class="z-source z-cs"><span class="z-storage z-type z-variable z-cs">var</span> <span class="z-variable z-other z-cs">dictionary</span> <span class="z-keyword z-operator z-assignment z-variable z-cs">=</span> <span class="z-meta z-instance z-cs"><span class="z-keyword z-operator z-new z-cs">new</span></span><span class="z-meta z-instance z-cs"> </span><span class="z-meta z-instance z-cs"><span class="z-support z-type z-cs">Dictionary</span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-begin z-cs">&lt;</span></span><span class="z-meta z-generic z-cs"><span class="z-storage z-type z-cs">int</span><span class="z-punctuation z-separator z-type z-cs">,</span> <span class="z-storage z-type z-cs">string</span></span><span class="z-meta z-generic z-cs"><span class="z-punctuation z-definition z-generic z-end z-cs">&gt;</span></span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-instance z-cs"><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span><span class="z-source z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">GetOrAdd</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-constant z-numeric z-integer z-decimal z-cs">1</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-string z-quoted z-double z-cs"><span class="z-punctuation z-definition z-string z-begin z-cs">&quot;</span>Value1<span class="z-punctuation z-definition z-string z-end z-cs">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span><span class="z-source z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">TryUpdate</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-constant z-numeric z-integer z-decimal z-cs">1</span><span class="z-punctuation z-separator z-argument z-cs">,</span> <span class="z-string z-quoted z-double z-cs"><span class="z-punctuation z-definition z-string z-begin z-cs">&quot;</span>UpdatedValue1<span class="z-punctuation z-definition z-string z-end z-cs">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span>
</span><span class="z-source z-cs">
</span><span class="z-source z-cs"><span class="z-variable z-other z-cs">Console</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">WriteLine</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">JsonSerializer</span><span class="z-punctuation z-accessor z-dot z-cs">.</span><span class="z-meta z-function-call z-cs"><span class="z-variable z-function z-cs">Serialize</span><span class="z-meta z-group z-cs"><span class="z-punctuation z-section z-group z-begin z-cs">(</span></span></span><span class="z-meta z-function-call z-cs"><span class="z-meta z-group z-cs"><span class="z-variable z-other z-cs">dictionary</span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-section z-group z-end z-cs">)</span></span></span><span class="z-punctuation z-terminator z-statement z-cs">;</span> <span class="z-comment z-line z-double-slash z-cs"><span class="z-punctuation z-definition z-comment z-cs">//</span> {&quot;1&quot;:&quot;UpdatedValue1&quot;}
</span></span></code></pre>
<p>Как видите, эти методы делают работу со словарем более эффективной и чистой.</p>
<h2 id="zakliuchenie">Заключение</h2>
<p>Подведем итоги:</p>
<ul>
<li>Использование <code>ContainsKey</code> и <code>TryGetValue</code> может быть неэффективным из-за двойного хеширования.</li>
<li>Методы <code>CollectionsMarshal</code> позволяют оптимизировать работу со словарями.</li>
<li>Создание своих методов расширения поможет сделать ваш код более удобным и производительным.</li>
</ul>
<p>Дополнительные источники:</p>
<ul>
<li><a rel="noopener" target="_blank" href="https://github.com/just-squad/just-platform-dotnet/blob/main/src/JustPlatform.Extensions/DictionaryExtensions.cs">Ссылка на проект с исходным кодом</a></li>
<li><a rel="noopener" target="_blank" href="https://www.youtube.com/watch?v=6CWQXQISYpk">YouTube видео</a></li>
</ul>

      <nav>
        <div>
          <a href="https://baldman.justsquad.su/rust-work-with-configs/">&#8249; Rust. Работа с конфигурациями</a>
        </div>
        <div>
          <a href="https://baldman.justsquad.su/kuber-cert-manager/"> Получение сертификатов в k3s (k8s) через cert-manager &#8250;</a>
        </div>
      </nav>
    </article>

    <div class="sblock">
      <div class="blockdiv">
        <a class="b s150" href="https://baldman.justsquad.su/tags/dotnet/">Series</a><br>
            
      <a class="scur" href="https://baldman.justsquad.su/csharp-dictionary-speed-improvment/">Ускоряем работу C# Dictionary в 2 раза.</a><br>
    
      </div>
  </main>
  <footer>
    <div class="c">
      <nav class="tpad"><div><a class="js m-protected" href="#bmlrb2xhaWd1c2hhcmluQHlhLnJ1" target="_blank" title="Mail"><i type="Button" class="svg mail" title="Mail"></i></a><a href="https://github.com/ni-gushch/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a><a href="https://www.youtube.com/@baldman_g" target="_blank" title="YouTube"><i type="Button" class="svg youtube" title="YouTube"></i></a><a href="https://t.me/bald_man_g/" target="_blank" title="Telegram"><i type="Button" class="svg telegram" title="Telegram"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://baldman.justsquad.su/about/"> Обо мне </a>
        <a class="rpad s90" href="https://baldman.justsquad.su/contact/"> Контакты </a>
        <a class="rpad s90" href="https://baldman.justsquad.su/sitemap.xml" target="_blank"> Карта сайта </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2025</span> BaldMan</p>
      <p class="s80">Работает на <a href="https://www.getzola.org/" target="_blank">Zola</a> и <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>
