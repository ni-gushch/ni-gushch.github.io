+++
title = "Получение сертификатов в k3s (k8s) через cert manager."
description = "Способ автоматизировать процесс получения сертификатов для локального контура с использованием cert manager и DNS01 challenge."
date = 2025-02-12
draft = false

[taxonomies]
tags = ["kubernetes","k3s", "k8s", "certmanager", "letsencrypt"]
[extra]
keywords = "kubernetes, k3s, k8s, cert-manager, letsencrypt"
#thumbnail = "ferris-gesture.png"
#toc = true
series = "kubernetes"
+++

Наличие SSL сертификатов в наше время является неотъемлемой частью безопасности разворачиваемых ресурсов. А когда я занялся организацией своего сервера и поднял k3s кластер, то сразу задумался о том, как обеспечить Web сервисы валидными сертификатами.

Приведу "маленькую историческую справку", о том, что такое SSL сертификаты, зачем они нужны, и что такое доверенные центры сертификации. Дальше это пригодится.

## SSL сертификаты и HTTPs соединение

**SSL-сетификат** - это цифровой документ, который подтверждает подлинность web-ресурса и шифрует данные, передаваемые между клиентом и сервером. Он подтверждает, что клиент общается именно с тем сайтом, который заявлен, а не с поддельным. Потому что скомпроментировать сертификат достаточно сложно, в самом простом варианте необходимо пробраться на серверную часть ресурса и украсть секретную часть ключа. 

**SSL (Secure Sockets Layer)** - технология, которая обеспечивает безопасное соединение. В последнее время стали чаще использовать аббревеатуру TLS (Transport Layer Security). Этот протокол защищает информацию, которую пользователь отправляет на сторону сервера или получает от него. Например логины и пароли, данные банковских карт. Если же не использовать шифрование, то обычный HTTP трафик очень легко перехватить и прочитать содержимое пакета.

**HTTPS (HyperText Transfer Protocol Secure)** - это защищенная версия протокола HTTP, использующая сертификаты и технологии SSL/TLS для шифрования данных.

## Доверенные центры сертификации (CA)

Центры сертификации (Certificate authorities) - это организации, которые занимаются выдачей SSL-сертификатов. Их задачей является проверить, что пользователь, запросивший сертификат, является владельцем домена, на который запрашивается сертификат, и подтверждают подлинность. Другими словами эти организации выступают своего рода гарантами взаимосвязи домена и владельца, а в подтверждении выдают подписанный документ (с печатью) - сертификат. Приведу список известных центров сертификации: 

- Let's Encrypt (который использоваться в статье)
- DegiCert
- Comodo
- GlobalSign

Как происходит обмен данными:

1. **Клиент (браузер)** запрашивает соединение с сервером (например, при переходе на сайт).
2. **Сервер** отправляет клиенту свой SSL-сертификат.
3. **Клиент** проверяет сертификат (может проверить самостоятельно или обратиться к центру сертификации, который выдал документ):
   - Доверен ли центр сертификации?
   - Не истек ли срок действия сертификата?
   - Соответствует ли доменное имя сертификата запрашиваемому сайту?
4. Если проверка прошла успешно, **клиент и сервер** устанавливают безопасное соединение с использованием шифрования (например, с помощью алгоритмов RSA или ECDHE).
5. После этого данные передаются в зашифрованном виде. Например, если вы вводите пароль на сайте, он будет зашифрован и расшифрован только на сервере.

## Как получить SSL сертификат

Есть несколько путей получения сертификата. Кратко рассмотрим их.

### Создание самоподписных сертификатов

Делается это достаточно легко, через утилиту `openssl` (linux). Используя всего несколько команд мы получаем 2 файлика, сам сертификат и ключ. Их уже можно привязывать к веб серверу. Весь процесс выдачи описывать не вижу смысла, по этому поводу есть куча статей, например вот [эта](https://habr.com/ru/articles/352722/).

Какие минусы у этого подхода.

- придется прописывать сертификат в каждом браузере, на каждом устройстве. Потому что мы будем являться CA, а весь мир не знает о существовании Иванова Ивана, который считает себя доверенным центром сертификации. Поэтому при входе на такой сайт браузер будет ругаться по причине невозможности проверить сам центр сертификации. 
- Следить за валидностью и временем жизни придется самостоятельно. И вовремя обновлять. Можно сделать себе заметку в календаре, но не редко встречал ситуации в больших компаниях, когда забывали выпустить новые сертификаты и работа вставала на пол дня.

### Использование утилиты `certbot`

Эта утилита позволит в автоматическом режиме получить сертификат **Let's Encrypt** под указанный домен. Так же можно получить wildcart сертификат, который будет доступен для все возможные вариации указанного домена. Например мы получаем ssl для `example.com` и он доступен только для него, если же мы получаем ssl для `*.example.com`, то мы сможем использовать этот сертификат как для `one.example.com`, так и для `two.example.com` и даже для `one.two.example.com`. Есть специальные утилиты, которые позволяют автоматически прописывать полученные сертификаты в конфигурацию web сервера nginx. Этот вариант хорош, и вполне себе используемый, но у него все же есть некоторые ограничения. Контролировать и перевыпускать сертификаты придется самостоятельно. Да, у LetsEncrypt была система оповещения о сроке окончания сертификата, но начиная с февраля 2025 года она закрывают поддержку этого функционала. Можно еще самостоятельно написать утилиту для автоматического отслеживания и обновления или найти ее на просторах интернета. Но я хотел, чтобы все работало из коробки. Да, я ленивый инженер. И еще один момент. Мы развернули k3s кластер, и через certbot пришлось бы специфиным образом подкидывать сертификаты к ingress-ам.

И есть еще один вариант, который можно изящно использовать в среде kubernates. Это использование сервиса `cert-manager`.


